<!DOCTYPE html>
<!-- saved from url=(0051)https://demo.buddycloud.org/prototypes/private.html -->
<html lang="en" class=" js history csstransforms csstransforms3d fontface localstorage" ng-app="XmppApp">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Streams</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript" src="assets/scripts/primus.js"></script>
    <!-- compiled CSS -->
    <% styles.forEach( function ( file ) { %>
        <link rel="stylesheet" type="text/css" href="<%= file %>" />
        <% }); %>
            <!-- compiled JavaScript -->
            <% scripts.forEach( function ( file ) { %>
                <script type="text/javascript" src="<%= file %>"></script>
                <% }); %>

                    <link rel="stylesheet" href="assets/css/style.less" type="text/css" media="screen" />
                    <script type="text/javascript">
                        var SCOPE = null;

                        angular.module('XmppApp', [
                            'templates-app', 'templates-common', 'AngularXmpp', 'XmppUI', 'btford.markdown', 'tagged.directives.infiniteScroll', 'ngSanitize', 'ui.bootstrap', 'angularMoment'
                        ])


                        .controller('page', ['$scope', '$rootScope', '$location',
                            function($scope, $rootScope, $location) {

                                //        function page($scope, $rootScope, $location) {
                                SCOPE = $scope;
                                $scope.node = "recent";
                                $scope.openchat = function(node) {
                                    $scope.xmpp.openchat($scope.xmpp.parseNodeString(node).jid);
                                }
                                $scope.changenode = function(node) {
                                    $scope.node = node;
                                    $scope.nodeuser = $scope.xmpp.parseNodeString(node);
                                    $location.hash(node);
                                }
                                $scope.open = function(jid) {
                                    console.log(jid);
                                    $scope.changenode(jid);
                                };
                                $scope.initbuddycloud = function(bc) {
                                    $scope.buddycloud = bc;
                                    console.log("bc", bc);
                                }
                                $scope.initxmpp = function(xmpp) {
                                    $scope.xmpp = xmpp;
                                    var username=localStorage.getItem("username");
                                    var password=localStorage.getItem("password");
                                    if(username && password){
                                        xmpp.send('xmpp.login', {
                                            jid: username,
                                            password: password,
                                            resource: 'angular-xmpp',
                                            register: false
                                        }).then(function() {
                                            $scope.jid = $scope.xmpp.data.me.jid.user + "@" + $scope.xmpp.data.me.jid.domain;
                                            xmpp.send("xmpp.presence");
                                            xmpp.send("xmpp.roster.get");
                                        });
                                    }

                                }
                                $scope.login=function(username,password,register,stayloggedin){
                                    if(username.indexOf("@")===-1){
                                        username=username+'@laos.buddycloud.com';
                                    }
                                    if(stayloggedin){
                                        localStorage.setItem("username",username);
                                        localStorage.setItem("password",password);
                                    }
                                    console.log(username,password,register);
                                    $scope.xmpp.send('xmpp.login', {
                                        jid: username,
                                        password: password,
                                        resource: 'angular-xmpp',
                                        register: register
                                    }).then(function() {
                                        $scope.jid = $scope.xmpp.data.me.jid.user + "@" + $scope.xmpp.data.me.jid.domain;
                                        $scope.xmpp.send("xmpp.presence");
                                        $scope.xmpp.send("xmpp.roster.get");
                                    });

                                }
                                $scope.logout=function(){
                                        console.log("logout");
                                        localStorage.removeItem("username");
                                        localStorage.removeItem("password");
                                        $scope.xmpp.socket.send('xmpp.logout');
                                }
                                $scope.showxmpp = function() {
                                    console.log("xmpp", $scope.xmpp, $scope.buddycloud); //debug
                                }
                                $scope.initchat = function(chat) {
                                    $scope.chat = chat;
                                }

                                $rootScope.$on('$locationChangeSuccess', function(data) {
                                    if ($location.hash() == "") {
                                        node = "recent";
                                    } else {
                                        node = $location.hash();
                                    }
                                    $scope.changenode(node);

                                });
                            }
                        ])

                        .filter('getJidString', function() {
                            return function(item) {
                                var user = "";
                                var domain = "";
                                if (item.indexOf("@") !== -1) {
                                    user = item.split("@")[0];
                                } else {
                                    user = item;
                                }
                                if (user.indexOf("/") !== -1) {
                                    user = user.substring(user.lastIndexOf("/") + 1);
                                }

                                if (item.indexOf("@") !== -1) {
                                    domain = item.split("@")[1];
                                } else {
                                    domain = item;
                                }
                                if (domain.indexOf("/") !== -1) {
                                    domain = domain.substring(0, domain.indexOf("/"));
                                }
                                return user + "@" + domain;
                            }
                        })
                    </script>
</head>

<body ng-controller="page">
    <div ng-if="!xmpp.data.me" ng-include="'assets/partials/landing.html'"></div>
    <div ng-show="xmpp.data.me">
    <xmpp althost="https://laos.buddycloud.com" host="http://localhost:3000" oninit="initxmpp(scope)">
        <div style="position:absolute;top:200px;left:20px;z-index:1000;background-color:white;">
            <xmpplogin></xmpplogin>
            <div style="display:block">


            </div>
        </div>
        <xmppminichat oninit="initchat(scope)"></xmppminichat>

        <div class="sidebar">
            <div class="personal channel" style="width:100%;height:80px">
                <div class="avatar" style="background-image: url(assets/icons/avatars/{{xmpp.data.me.jid.user}}.png)" ng-click="changenode('recent')">
                    <span class="channelpost counter">2</span>
                    <span class="message counter" ng-if="chat.notifications.unreadmessages">{{chat.notifications.unreadmessages}}</span>
                </div>
                <div class="info">
                    <span class="owner">{{xmpp.data.me.jid.user}}</span>
                    <span class="status">Aww yeah, Mountain Lion rocks</span>
                </div>
                <div class="settings noSelect">
                    <div class="popup">
                        <div class="centered vertical">
                            <div class="arrow"></div>
                            <ul>
                                <li class="newChannel"><a href="https://demo.buddycloud.org/prototypes/editChannel.html">Create Topic Channel</a>
                                </li>
                                <li class="preferences"><a href="https://demo.buddycloud.org/prototypes/preferences.html">Preferences</a>
                                </li>
                                <li class="logout" ng-click="logout()">Logout
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="actionBar clearfix">
                <button class="discover"><span>Find Channels</span>
                </button>
            </nav>
            <div class="channels">
                <div class="antiscroll-inner scrollHolder">
                    <div class="bubbleHolder" style="height: 66px;">
                        <div class="channel bubbling" style="top: 0px; z-index: 4;">


                            <div ng-repeat="node in buddycloud.buddycloud.data.subscriptions" ng-click="changenode(node.node)" class="menu" ng-class="{'selected':selectednode.node==node.node}">
                                <!--
<img ng-src="assets/icons/avatars/{{node.name}}.png" style="height:25px"/>
{{node.name}} <span ng-show="buddycloud.data.unread[node.node]" class="badge">{{buddycloud.data.unread[node.node]}}</span>
<button class="btn btn-xs btn-link  pull-right" ng-click="xmpp.openchat(node.jid)" style="position:relative">
<span class="glyphicon glyphicon-envelope " aria-hidden="true" ></span>
<span ng-show="chat.notifications.unread[node.jid]" class="label label-success label-as-badge" style="position:absolute;top:-2px;left:12px;font-size:9px;backgroung-color:yellow">{{chat.notifications.unread[node.jid]}}</span>
</button>
</div>
-->

                                <div class="channel thechannel" ng-class="{'selected':node.node==buddycloud.buddycloud.data.currentnode}">
                                    <div class="avatar" style="background-image: url(assets/icons/avatars/{{node.node|getUser}}.png)">
                                        <span class="channelpost counter" ng-if="buddycloud.buddycloud.data.unread[node.node]">{{buddycloud.buddycloud.data.unread[node.node]}}</span>
                                        <!-- sorry -->
                                        <span class="channelpost counter admin" ng-if="chat.notifications.unread[buddycloud.buddycloud.data.affiliations[node.node].owner[0].jid.user+'@'+buddycloud.buddycloud.data.affiliations[node.node].owner[0].jid.domain]" ng-click="openchat(node.node);">{{chat.notifications.unread[buddycloud.buddycloud.data.affiliations[node.node].owner[0].jid.user+'@'+buddycloud.buddycloud.data.affiliations[node.node].owner[0].jid.domain]}}</span>
                                    </div>
                                    <div class="info">
                                        <span class="owner">{{node.node|getUser}}</span>
                                        <span class="status">I can haz your nose?</span>
                                    </div>
                                </div>
                                <br/>
                                <br/>
                                <br/>

                            </div>
                            <!--
          <div class="info">
            <span class="owner">music<span class="domain">@buddycloud.com</span></span>
            <span class="status">New Foo Fighter Album online - check it out!</span>
          </div>
        </div></div><div class="bubbleHolder" style="height: 66px;"><div class="channel bubbling" style="top: 0px; z-index: 3;">
          <div class="avatar" style="background-image: url(avatars/channel3.jpg)">
            <span class="channelpost counter admin">1</span>
          </div>
          <div class="info">
            <span class="owner">On the Box</span>
            <span class="status">You gonna love the new Dexter episodes</span>
          </div>
        </div></div><div class="bubbleHolder" style="height: 66px;"><div class="channel bubbling" style="top: 0px; z-index: 2;">
          <div class="avatar" style="background-image: url(img/topic-50px.jpg)">
            <span class="channelpost counter">2</span>
          </div>
          <div class="info">
            <span class="owner">Lolcats</span>
            <span class="status">I can haz your nose?</span>
          </div>
        </div></div>
        <div class="channel selected">
          <div class="avatar" style="background-image: url(avatars/user2.jpg)">
            <span class="channelpost counter">2</span>
          </div>
          <div class="info">
            <span class="owner">Vera Maier</span>
            <span class="status">What a wonderful day</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel2.jpg)">
            <span class="channelpost counter admin">1</span>
          </div>
          <div class="info">
            <span class="owner">Moviefans</span>
            <span class="status">Harry Potter, tonight!</span>
          </div>
        </div>
        <div class="startingArea" style="height: 0px;"></div>
        <div class="startingArea" style="height: 0px;"></div>
        <div class="channel">
          <div class="avatar" style="background-image: url(img/personal-50px.jpg)">
          </div>
          <div class="info">
            <span class="owner">Martin Rackel</span>
            <span class="status">working on the webgl project</span>
          </div>
        </div>
        <div class="startingArea" style="height: 0px;"></div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/user7.jpg)">
          </div>
          <div class="info">
            <span class="owner">verena<span class="domain">@buddycloud.com</span></span>
            <span class="status">test's are over - party!!!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel7.jpg)">
          </div>
          <div class="info">
            <span class="owner">fans<span class="domain">@steam.com</span></span>
            <span class="status">the cake is a lie!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel8.jpg)">
          </div>
          <div class="info">
            <span class="owner">cave<span class="domain">@minecraft.com</span></span>
            <span class="status">Buy minecraft - now!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(img/personal-50px.jpg)">
            <span class="channelpost counter">2</span>
          </div>
          <div class="info">
            <span class="owner">steve<span class="domain">@buddycloud.com</span></span>
            <span class="status">all your base belongs to us</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel2.jpg)">
            <span class="channelpost counter admin">1</span>
          </div>
          <div class="info">
            <span class="owner">moviefans<span class="domain">@buddycloud.com</span></span>
            <span class="status">Harry Potter, tonight!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel3.jpg)">
            <span class="channelpost counter admin">1</span>
          </div>
          <div class="info">
            <span class="owner">on-the-box<span class="domain">@bbc.co.uk</span></span>
            <span class="status">You gonna love the new Dexter episodes</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel4.jpg)">
            <span class="channelpost counter">2</span>
          </div>
          <div class="info">
            <span class="owner">lolcats<span class="domain">@buddycloud.com</span></span>
            <span class="status">I can haz your nose?</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/user4.jpg)">
          </div>
          <div class="info">
            <span class="owner">martin<span class="domain">@buddycloud.com</span></span>
            <span class="status">working on the webgl project</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel6.jpg)">
          </div>
          <div class="info">
            <span class="owner">music<span class="domain">@buddycloud.com</span></span>
            <span class="status">New Foo Fighter Album online - check it out!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/user7.jpg)">
          </div>
          <div class="info">
            <span class="owner">verena<span class="domain">@buddycloud.com</span></span>
            <span class="status">test's are over - party!!!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel7.jpg)">
          </div>
          <div class="info">
            <span class="owner">fans<span class="domain">@steam.com</span></span>
            <span class="status">the cake is a lie!</span>
          </div>
        </div>
        <div class="channel">
          <div class="avatar" style="background-image: url(avatars/channel8.jpg)">
          </div>
          <div class="info">
            <span class="owner">cave<span class="domain">@minecraft.com</span></span>
            <span class="status">Buy minecraft - now!</span>
          </div>
        </div>
-->
                        </div>
                    </div>
                    <!-- /antiscroll-inner -->
                </div>
                <!-- /channels -->
            </div>
        </div>
        <div class="content">
            <div class="channelView personal clearfix">
                <header class="channelHeader justify">
                    <div ng-repeat="item in buddycloud.buddycloud.data.config" ng-if="item.var=='pubsub#owner'" class="avatar big" style="background-image:url('assets/icons/avatars/{{item.value|getUser}}.png');"></div>
                    <div class="flex titleText">
                        <h2 class="owner" ng-repeat="item in buddycloud.buddycloud.data.config" ng-if="item.var=='pubsub#title'">{{item.value}}</h2>
                        <div class="about" ng-repeat="item in buddycloud.buddycloud.data.config" ng-if="item.var=='pubsub#description'">{{item.value}}</div>

                    </div>
                    <nav class="inChannel">
                        <!--<span class="messages button newMessage">
            <span class="holder">Messages</span><span class="message counter">2</span>
          </span>-->
                        <span class="channel button">
            <span class="holder">Channel</span>
                        </span>
                        <span class="hidden save button">Save</span>
                        <!--<span class="edit button">Edit</span>-->
                        <div ng-show="node!=='recent'">
                            <span class="button" ng-show="buddycloud.buddycloud.unsubscribe" ng-click="buddycloud.buddycloud.unsubscribe({node:node});">Unfollow</span>
                            <span class="button" ng-show="buddycloud.buddycloud.subscribe" ng-click="buddycloud.buddycloud.subscribe({node:node});">Follow</span>
                            <span class="button" ng-show="buddycloud.buddycloud.config" ng-click="showconfigform=!showconfigform">Config</span>
                        </div>
                    </nav>
                    <a href="http://www.buddycloud.com/" id="poweredby">powered by buddycloud</a>
                </header>
                <div class="centered start">
                    <section class="stream private clearfix buddycloud">
                        <buddycloud node="{{node}}" jid="jid" changenode="changenode(node,bc)" oninit="initbuddycloud(scope)"></buddycloud>

                    </section>
                    <!-- /stream -->
                    <div class="channelDetails">
                        <div class="infoToggle">
                            <h4 class="title">Info</h4>
                            <span class="icon"></span>
                        </div>
                        <div class="holder">
                            <section class="meta">
                                <p class="address">
                                    <span class="title">Address:</span>
                                    <span class="data" ng-click="openchat(node)">{{nodeuser.user}}@{{nodeuser.domain}}</span>
                                </p>
                                <p class="open">
                                    <span class="title">This Channel is:</span>
                                    <span class="data accessModel" ng-repeat="item in buddycloud.buddycloud.data.config" ng-if="item.var=='pubsub#access_model'">{{item.value}}</span>
                                </p>
                                <p class="broadcast">
                                    <span class="title">Broadcasting since:</span>
                                    <span ng-repeat="item in buddycloud.buddycloud.data.config" ng-if="item.var=='pubsub#creation_date'" am-time-ago="item.value"></span>
                                </p>
                            </section>
                            <section class="channelList">
                                <div ng-repeat="(key,node) in buddycloud.buddycloud.data.affiliations[buddycloud.buddycloud.data.currentnode]">
                                    <h3>{{key}}  <span class="count">{{node.length}}</span></h3>
                                    <div class="list" ng-repeat="item in node" style="background-image:url('assets/icons/avatars/{{item.jid.user}}.png');background-size:cover;width:30px;height:30px;border:1px solid black;display:inline-block;margin:4px" ng-click="buddycloud.open({'node':'/user/'+item.jid.user+'@'+item.jid.domain+'/posts'})" title="{{item.jid.user+'@'+item.jid.domain}}"></div>
                                </div>





                            </section>
                            <!-- /followers -->
                            <!--
            <section class="channelList">
              <h3>followers <span class="count">20</span></h3>
              <div class="list">
                <img src="./Streams_files/user3.jpg" class="selected">
                <img src="./Streams_files/user4.jpg">
                <img src="./Streams_files/user5.jpg">
                <img src="./Streams_files/user6.jpg">
                <div class="adminAction first">
                  <div class="arrow"></div>
                  <div class="holder">
                    <div class="box">
                      <section class="channelInfo">
                        <h4>tom@buddycloud.com</h4>
                        <div class="currentRole">Follower</div>
                      </section>
                      <section class="action changeRole">
                        <h5>Change Role</h5>
                        <select>
                          <option value="moderator">Moderator</option>
                          <option value="followerPlus">Follower+Post</option>
                          <option value="follower" selected="">Follower</option>
                        </select>
                        <section class="info">
                          <div class="moderator">
                            <ul>
                              <li>read your channel</li>
                              <li>write comments &amp; messages</li>
                              <li>post new topics</li>
                              <li>approve new followers</li>
                              <li>set user's roles</li>
                              <li>delete posts</li>
                            </ul>
                          </div>
                          <div class="followerPlus">
                            <ul>
                              <li>read your channel</li>
                              <li>write comments &amp; messages</li>
                              <li>post new topics</li>
                            </ul>
                          </div>
                          <div class="follower">
                            <ul>
                              <li>read your channel</li>
                            </ul>
                          </div>
                        </section>
                      </section>
                      <section class="action banUser">
                        <h5>Ban User</h5>
                        <div class="info">
                          <ul>
                            <li class="negative">Remove access to channel.</li>
                          </ul>
                        </div>
                      </section>
                      <section class="actionRow choose">
                        <div class="changeRoleButton">Change Role</div>
                        <div class="banUserButton">Ban User</div>
                      </section>
                      <section class="actionRow confirm">
                        <div class="cancelButton">Cancel</div>
                        <div class="okButton">Ok</div>
                      </section>
                    </div>
                  </div>
                </div>
                <img src="./Streams_files/user7.jpg">
                <img src="./Streams_files/user8.jpg">
                <img src="./Streams_files/user9.jpg">
                <img src="./Streams_files/user10.jpg">
                <img src="./Streams_files/user11.jpg">
                <img src="./Streams_files/user12.jpg">
                <img src="./Streams_files/user13.jpg">
                <img src="./Streams_files/channel8.jpg">
              </div>
-->
                            <div class="showAll">show all</div>
                            </section>
                            <!-- /followers -->
                            <section class="channelList">
                                <h3>channels nearby <span class="count">10</span></h3>
                                <div class="list">
                                    <img src="./Streams_files/channel1.jpg">
                                    <img src="./Streams_files/channel2.jpg">
                                    <img src="./Streams_files/channel3.jpg">
                                    <img src="./Streams_files/channel4.jpg">
                                </div>
                                <div class="showAll">show all</div>
                            </section>
                            <!-- /followers -->
                            <section class="channelList">
                                <h3>similar channels <span class="count">8</span></h3>
                                <div class="list">
                                    <img src="./Streams_files/channel5.jpg">
                                    <img src="./Streams_files/channel6.jpg">
                                    <img src="./Streams_files/channel7.jpg">
                                    <img src="./Streams_files/channel8.jpg">
                                </div>
                                <div class="showAll">show all</div>
                            </section>
                            <!-- /followers -->
                        </div>
                        <!-- /holder -->
                    </div>
                    <!-- /detail -->
                </div>
            </div>
            <!-- /channelView -->
        </div>
        <!-- /content -->
        <script type="text/javascript">
            /* ###

  redraw function to make sure that transitions are triggered

  ### */
            ! function(document) {

                // (C) WebReflection (As It Is) - Mit Style

                // we all love function declarations
                function redraw() {

                    // clientHeight returns 0 if not present in the DOM
                    // e.g. document.removeChild(document.documentElement);
                    // also some crazy guy may swap runtime the whole HTML element
                    // this is why the documentElement should be always discovered
                    // and if present, it should be a node of the document
                    // In all these cases the returned value is true
                    // otherwise what is there cannot really be considered as painted

                    return !!(document.documentElement || 0).clientHeight;
                }

                // ideally an Object.defineProperty
                // unfortunately some engine will complain
                // if used against DOM objects
                document.redraw = redraw;

            }(document);

            /* ###

    Channel bubbling

    ### */
            var channelHolder = $('.channels');
            var innerHolder = channelHolder.find('.scrollHolder');
            var channels = channelHolder.find('.channel:not(".personal")');

             // prefixes for cutting edge css properties and javascript events:
             //
             //  transition => MozTransition
            var transition = Modernizr.prefixed('transition');
             //  transform => MozTransform
            var transform = Modernizr.prefixed('transform');
            var transEndEventNames = {
                    'WebkitTransition': 'webkitTransitionEnd',
                    'MozTransition': 'transitionend',
                    'OTransition': 'oTransitionEnd',
                    'msTransition': 'msTransitionEnd', // maybe?
                    'transition': 'transitionEnd'
                }
                //  transitionendEvent => transitionend
            var transitionendEvent = transEndEventNames[transition];
             // cache channelHeight - it's the same for every channel-preview
            var channelHeight = channels.first().outerHeight();
             // count of currently moving channels
            var movingChannels = 0;

            /*

  Stress test:

  $('.channel:not(".personal")').each(function(i, channel){
      setTimeout( function(){ $(this).click() }.bind(this), i*250);
  });

  Reality test:

  $('.channel:not(".personal")').each(function(i, channel){
      setTimeout( function(){ $(this).click() }.bind(this), i*Math.round(Math.random()*2500));
  });

  An even more real test:

  time = 5000;

  function goCrazy(){
  var allChannels = $('.channel:not(".personal")');
  allChannels.eq( Math.round( Math.random()*allChannels.size() ) ).click();
    timer = setTimeout(goCrazy, Math.random()*time);
  }
  goCrazy();

  */

            function bubble() {
                var bubblingChannel = $(this);

                // relative offset + absolute offset
                var offset = bubblingChannel.position().top + innerHolder.scrollTop();

                // don't bubble if the channel is..
                //  - on top
                //  - bubbling
                if (offset === 0 || bubblingChannel.parent().hasClass('bubbleHolder')) {
                    return false;
                }

                // create a gap where the channel starts off
                var startingArea = $('<div>').height(channelHeight).addClass('startingArea');
                bubblingChannel.before(startingArea);

                document.redraw();

                startingArea.bind(transitionendEvent, destroy);

                // close startingArea
                startingArea.css('height', 0);

                // detach the bubbling channel from the DOM
                // and insert it at the top
                bubblingChannel.detach().css('top', offset);
                innerHolder.prepend(bubblingChannel);

                // wrap a growing holder around it
                var landingArea = $('<div>').addClass('bubbleHolder');
                bubblingChannel.wrap(landingArea);

                document.redraw();

                // bind the callback on transition end for all bubbling channels
                bubblingChannel.bind(transitionendEvent, reset);

                // bubble!
                bubblingChannel.addClass('bubbling').css({
                    'top': 0,
                    'z-index': ++movingChannels + 1
                });
                // open a gap for the channel to arrive
                bubblingChannel.parent().css('height', channelHeight);
            }

            function destroy(event) {
                var propertyToWaitFor = event.data.propertyName;
                if (propertyToWaitFor !== undefined && event.originalEvent.propertyName === propertyToWaitFor)
                    $(this).remove();
            }

            function reset(event) {
                if (event.data && event.data.callback) event.data.callback();
                // reset the bubbling channel and unwrap it
                $(this).removeClass('bubbling').css({
                    'height': '',
                    'z-index': ''
                }).unwrap();
                movingChannels--;
            }
            channels.click(bubble);
             //channels.toggle(function(){ $(this).css('background', 'red'); }, function(){ $(this).css('background', 'green'); });

            /* ###

    show/hide channel info

    ### */
            var channelInfo = $('.channelDetails');
            var channelInfoToggle = channelInfo.find('> .infoToggle');

            channelInfoToggle.click(function() {
                channelInfo.toggleClass('hidden');
            });

            $('.showAll').click(function() {
                var list = $(this).prev();
                list.children().clone().appendTo(list);
                $(this).remove();
            });

            /* ###

    new topic animation

    ### */

            $('.opener, .comment').each(function() {
                var post = $(this);
                post.find('button.delete').click(function() {
                    post.toggleClass('dangerZone');
                });
            });

             // works for both new topic field and all the small answer fields
            var newTopic = $('.newTopic, .answer');
            var topicTextarea = newTopic.find('textarea');

            function openArea(event) {
                // prevent bubbling!
                event.stopPropagation();
                if (!$(this).hasClass('write')) {
                    $(this).addClass('write');
                    $(document).one('click', {
                        self: this
                    }, closeArea);
                }
            }

            function closeArea(event) {
                var self = event.data.self;
                var textarea = $(self).find('textarea');
                // minimize the textarea only if the textarea is empty
                if (textarea.val() === "") {
                    $(self).removeClass('write');
                }
            }

            newTopic.click(openArea);

            /* ###

    notification animation

    ### */

            var notification = $('.notification');
            var notificationButtons = notification.find('.controls > div');

            function notify() {
                notification.addClass('visible');
            }

            function logNotifaction() {
                var reaction = $(this).hasClass('positive') ? 'granted' : 'denied';
                notification.addClass('log ' + reaction);
            }

            notificationButtons.click(logNotifaction);
             //setTimeout('notify()', 2000);

            $(function() {
                //$('#channels').antiscroll();
            }); //*/

            /* ###

      edit mode

  */

            var editableElements = [
                'header .title',
                'header .status',
                '.meta .description',
                '.meta .accessModel',
                '.location .previous',
                '.location .current',
                '.location .next'
            ];

            function fauxLoadEditedStuff() {
                for (var i = 0, l = editableElements.length; i < l; i++) {
                    var el = editableElements[i];
                    if ($(el).data('editmode') !== 'boolean') {
                        if (localStorage[el]) $(el).text(localStorage[el]);
                    }
                }
            }

            fauxLoadEditedStuff();

            $('.edit.button').click(function() {
                if (!$('html').hasClass('editmode')) {
                    $('html').addClass('editmode');
                    startEditMode();
                } else {
                    $('html').removeClass('editmode');
                    stopEditMode(true);
                }
            });

            function startEditMode() {
                for (var i = 0, l = editableElements.length; i < l; i++) {
                    var el = editableElements[i];
                    if ($(el).data('editmode') !== 'boolean') {
                        // store the current state
                        localStorage[el] = $(el).text();

                        // add designMode & contenteditable
                        $(el)
                            .prop('contenteditable', true)
                            .input(function() {
                                var text = $(this).text();
                                if (text === "") $(this).html("&nbsp;");
                            }).keydown(function(ev) {
                                var code = ev.keyCode || ev.which;
                                if ($(this).data('editmode') === 'singleLine' && code == 13) {
                                    ev.preventDefault();
                                    return false;
                                } else return true;
                            });
                        // only allow enter when the target is not singleLine
                    }
                }
                $(editableElements[0]).focus();
            }

            function stopEditMode(save) {
                for (var i = 0, l = editableElements.length; i < l; i++) {
                    var el = editableElements[i];
                    if ($(el).data('editmode') !== 'boolean') {

                        // remove designMode & contenteditable
                        $(el).prop('contenteditable', false);

                        // compare the current state with the pre-edit state and store the changed elements
                        if ($(el).text() != localStorage[el]) {
                            if (save) {
                                localStorage[el] = $(el).text();
                            } else {
                                $(el).text(localStorage[el]);
                            }
                        }
                    }
                }
            }


            /* ###

      search

  ### */

            $('input[type=search]').bind('input', search);
             // channels = $('#channels .channel');

            function search() {
                var text = this.value;
                channels.each(function(i, el) {
                    // check if the text is in there
                    // add class hidden if text is not the same
                    if ($(el).text().indexOf(text) !== -1) {
                        $(el).removeClass('hidden');
                    } else {
                        $(el).addClass('hidden');
                    };
                });
            }

            /* ###

    unfollow

    ### */

            $('.inChannel').on('click', '.unfollow', function() {
                // rename button
                $(this).text('Follow').removeClass('unfollow').addClass('follow');

                var channelToRemove = $('.channel.selected');
                channelToRemove.bind(transitionendEvent, {
                    propertyName: 'height'
                }, destroy);

                document.redraw();

                channelToRemove.addClass('remove');
            });

            /* ###

    follow

    ### */

            function channelTemplate(avatarUrl, owner, status, animationClassName) {
                return $('<div class="channel">')
                    .addClass(animationClassName ? animationClassName : "")
                    .append(
                        $('<div class="avatar">').css('background-image', avatarUrl)
                    )
                    .append(
                        $('<div class="info">')
                        .append(
                            $('<div class="owner">').text(owner)
                        )
                        .append(
                            $('<div class="status">').text(status)
                        )
                    );
            }

            $('.inChannel').on('click', '.follow', follow);

            function follow() {
                // TODO: scroll channel list up (animation) and the go on
                $(this).text('Unfollow').removeClass('follow').addClass('unfollow');

                var avatarUrl = $(this).parent().siblings('.avatar').css('background-image');
                var owner = $(this).parent().siblings().children('.owner').text();
                // the status will not be visible in the discovery
                // using the about for now
                var status = $(this).parent().siblings().children('.about').text();
                var animationClassName = 'channelHeader';
                console.log(avatarUrl);
                console.log(owner);
                console.log(status);
                // create new channel from template for the sidebar
                var newChannel = new channelTemplate(avatarUrl, owner, status, animationClassName);

                // get the start offset
                var offset = $(this).parents('.channelHeader').offset();
                var callback = function() {
                    $('.channels').removeClass('rainbowAnimationRunning');
                    $(this).addClass('selected').css({
                        left: '',
                        top: ''
                    });
                }.bind(newChannel);

                $('.channels').addClass('rainbowAnimationRunning');

                // start the animation
                rainbowAnimation(newChannel, offset, animationClassName, callback);
            }

            function rainbowAnimation(channel, offset, animationClassName, callback) {
                channel.css({
                    left: offset.left - innerHolder.offset().left,
                    top: offset.top - innerHolder.offset().top
                });
                innerHolder.prepend(channel);

                // wrap a growing holder around it
                var landingArea = $('<div>').addClass('bubbleHolder rainbowBubble');
                channel.wrap(landingArea);

                document.redraw();

                console.log(channel);
                // bind the callback on transition end for all bubbling channels
                channel.one(transitionendEvent, {
                    callback: callback
                }, reset);
                // bubble!
                channel.removeClass(animationClassName).css({
                    'top': 0,
                    'left': 0,
                    'z-index': ++movingChannels + 1
                });
                // open a gap for the channel to arrive
                channel.parent().css('height', channelHeight);
            }

            /* ###

    Show Settings

    ### */
            $('.settings').click(function() {
                $(this).toggleClass('showSettings');
            });
            $('.settings li').click(function(event) {
                event.stopPropagation();
            });


            $.fn.autoResize = function() {

                this.filter('.expandingArea').each(function() {

                    var $this = $(this);
                    var $textarea = $this.find('textarea');
                    var $span = $this.find('span');
                    var textarea = $textarea[0];
                    var span = $span[0];

                    if (textarea.addEventListener) {
                        textarea.addEventListener('input', function() {
                            span.textContent = textarea.value;
                        }, false);
                        span.textContent = textarea.value;
                    } else if (textarea.attachEvent) {
                        // IE8 compatibility
                        textarea.attachEvent('onpropertychange', function() {
                            span.innerText = textarea.value;
                        });
                        span.innerText = textarea.value;
                    }
                    // Enable extra CSS
                    $this.addClass('active');

                });
            }

            $('.expandingArea').autoResize();
        </script>

    </xmpp>
    </div>
</body>

</html>
