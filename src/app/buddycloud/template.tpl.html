

<div ng-show="data " class="buddycloud" tagged-infinite-scroll="getMore()" tagged-infinite-scroll-disabled="fetching || disabled" tagged-infinite-scroll-distance="500">

    <!-- header -->
    <div g-show="!formdata">
    <div class="streamheader">
    <div ng-if="node!='recent'">
        <button ng-if="!data.rights.subscribed" ng-click="subscribe()" class="btn btn-link">subscribe</button>
        <button ng-if="data.rights.subscribed" ng-click="unsubscribe()" class="btn btn-link">unsubscribe</button>
        <button ng-if="data.rights.config" ng-click="getConfig()" class="btn btn-link">
            <span class="glyphicon glyphicon-cog"></span>
        </button>
        <button ng-if="isContact(node)" ng-click="addFriend(node)" class="pull-right btn btn-link">add Contact</button>
        <button ng-if="!isContact(node)" ng-click="removeFriend(node)" class="pull-right btn btn-link">remove Contact</button>
        <br/>
    </div>

    <!-- config form -->
    <div class="form" ng-show="formdata" style="position:relative;height:1300px">
            <xmppform formdata="formdata" onclose="formdata=null" onsave="setConfig"></xmppform>
    </div>

    <!-- main post form -->
    <form ng-show="data.rights.publish || data.currentnode=='recent'" ng-submit="publish()">
        <textarea ng-model="newtopic.value" placeholder="What's going on" ng-class="{'saving': newtopic.status == 'saving'}"></textarea>{{newtopic.status}}
        <input ng-show="newtopic.value" type="submit" />
    </form>
    </div>

    <div ng-if="!data.tree">loading...</div>


    <!-- the item loop -->
    <div ng-repeat="item in data.tree |toArray|orderBy:'entry.atom.published':true " class="item">
        {{entry.atom.published}}
        <span ng-if="item.rights.remove" class="tool pull-right" ng-click="removeitem(item.entry.atom.id,item.node)">×</span>
        <span ng-if="item.rights.update" class="tool pull-right" ng-click="edititem(editmode=!editmode)">✎</span>
        <img ng-src="assets/icons/avatars/{{item.entry.atom.author.image}}.png" />

        <!-- head -->
        <div class="person">
            <span class="name">
<span ng-click="opennode(item.entry.atom.author.name)">{{item.entry.atom.author.name}}</span>
            <span ng-click="opennode(item.nodeowner)" ng-show="item.entry.atom.author.name!=item.nodeowner && node=='recent'"> → {{item.nodeowner}}</span>
            </span>
            <span class="date">{{item.entry.atom.published | date:'medium'}}</span>
        </div>

        <!-- content -->
        <div class="content">
            <form ng-show="editmode && data.rights.subscribed" ng-submit="save()">
                <textarea ng-model="item.entry.atom.content.content"></textarea>
                <input type="submit" />
            </form>
            <div ng-show="!editmode" btf-markdown="item.entry.atom.content.content"></div>

        </div>
        <br/> 


        <!-- subitem loop -->
        <div ng-repeat="subitem in item.nodes  |toArray|orderBy:'entry.atom.published'" class="subitem">

            <!--  subitem -->
<!--
            <span ng-if="subitem.rights.remove" class="tool pull-right" ng-click="removeitem(subitem.entry.atom.id,subitem.node)">×</span>
            <span ng-if="subitem.rights.update" class="tool pull-right" ng-click="edititem(editmode=!editmode)">✎</span>
-->

<div class="tool btn-group pull-right" dropdown is-open="status.isopen">
      <button type="button" class="btn btn-link dropdown-toggle" dropdown-toggle ng-disabled="disabled">
         <span class="caret"></span>
      </button>
      <ul class="dropdown-menu" role="menu">
        <li><a href="#" ng-click="edititem(editmode=!editmode)">Edit action</a></li>
        <li><a href="#" ng-click="blockuser(subitem.entry.atom.id,subitem.node)">Block user</a></li>
        <li><a href="#" ng-click="makeusermanager(subitem.entry.atom.id,subitem.node)">Make user node manager</a></li>
        <li><a href="#" ng-click="makeuserreadonly(subitem.entry.atom.id,subitem.node)">Make user readonly</a></li>
        <li class="divider"></li>
        <li><a href="#" ng-click="removeitem(subitem.entry.atom.id,subitem.node)">Delete</a></li>
      </ul>
    </div>


            <img ng-src="assets/icons/avatars/{{subitem.entry.atom.author.image}}.png" />
            <div class="person">
                <span class="name" ng-click="opennode(subitem.entry.atom.author.name)">{{subitem.entry.atom.author.name}}</span>
                <input ng-show="editmode" ng-model="subitem.entry.atom.content.content" />
                <span ng-show="!editmode">{{subitem.entry.atom.content.content}}</span>

                <span class="date">{{subitem.entry.atom.published | date:'medium'}}</span>
            </div>
        </div>

        <!-- post replay -->
        <form ng-if="item.rights.publish" ng-submit="publish(item.entry.atom.id)" class="subitem">
            <img ng-src="assets/icons/avatars/{{jid.local}}.png" />
            <div class="person">
                <input ng-model="newitems[item.entry.atom.id].value" ng-class="{'saving': newitems[item.entry.atom.id].status == 'saving'}" class="form-control"/>
            </div>
        </form>
    </div>
    </div>
</div>

